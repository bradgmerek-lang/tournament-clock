<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hold Em Tournament Timer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
    --bg: #050609;
    --panel: #111824;
    --accent: #00d4ff;
    --accent-soft: rgba(0, 212, 255, 0.15);
    --danger: #ff4b5c;
    --text-main: #f5f7ff;
    --text-sub: #a4b1ce;
    --shadow-soft: 0 18px 40px rgba(0,0,0,0.45);
    --radius: 14px;
    --transition-fast: 0.2s ease-out;
    --transition-med: 0.35s ease-out;
    --level-highlight: #152338;
    --break-accent: #ffcc33;
    --overlay-bg: rgba(0,0,0,0.85);
}

* { box-sizing: border-box; }

body {
    margin: 0;
    min-height: 100vh;
    display: flex;
    align-items: stretch;
    justify-content: center;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: radial-gradient(circle at top, #17233a 0, #050609 50%, #000 100%);
    color: var(--text-main);
}

.app-container {
    display: grid;
    grid-template-columns: 3fr 2fr;
    gap: 18px;
    padding: 24px;
    width: 100%;
    max-width: 1400px;
}

.panel {
    background: linear-gradient(145deg, #0b1220, #050712);
    border-radius: var(--radius);
    box-shadow: var(--shadow-soft);
    padding: 18px 20px;
    border: 1px solid rgba(255,255,255,0.06);
    position: relative;
    overflow: hidden;
}

.panel::before {
    content: "";
    position: absolute;
    inset: -30%;
    background: radial-gradient(circle at top, rgba(0,212,255,0.08), transparent 55%);
    opacity: 0.7;
    pointer-events: none;
}

.panel-inner { position: relative; z-index: 1; }

h2, h3 {
    margin: 0 0 10px;
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
}
h2 { font-size: 14px; color: var(--text-sub); }
h3 { font-size: 13px; color: var(--text-sub); }

/* Editable title */
#editableTitle {
    font-size: 26px;
    font-weight: 700;
    color: var(--accent);
    background: transparent;
    border: none;
    width: 100%;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 0;
    margin: 0 0 4px 0;
}
#editableTitle:focus {
    outline: 2px solid var(--accent);
    background: rgba(0,212,255,0.08);
}

/* TIMER AREA */
.main-timer {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.timer-top-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
}

.timer-display {
    border-radius: 22px;
    padding: 26px 20px;
    background: radial-gradient(circle at top left, rgba(0,212,255,0.18), rgba(4,7,22,0.98));
    border: 1px solid rgba(255,255,255,0.08);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    transition:
        background var(--transition-med),
        border var(--transition-med),
        box-shadow var(--transition-med),
        transform 0.25s ease-out;
}

.timer-display.break-mode {
    background: radial-gradient(circle at top left, rgba(255,204,51,0.18), rgba(34,22,2,0.98));
    border-color: rgba(255,204,51,0.7);
    box-shadow: 0 0 32px rgba(255,204,51,0.35);
}

.time-remaining-label {
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.16em;
    color: var(--text-sub);
    margin-bottom: 6px;
}

.time-remaining-value {
    font-size: 80px;
    font-weight: 800;
    letter-spacing: 0.08em;
    text-shadow: 0 0 18px rgba(0,212,255,0.7);
}

.level-badge {
    margin-top: 8px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--accent);
    background: rgba(0,212,255,0.09);
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid rgba(0,212,255,0.35);
}

/* INFO CARDS */
.info-row {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 12px;
}

.info-card {
    background: rgba(12,16,32,0.9);
    border-radius: 12px;
    padding: 10px 12px;
    border: 1px solid rgba(255,255,255,0.04);
    display: flex;
    flex-direction: column;
    gap: 4px;
    transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
}

.info-card.highlight {
    background: var(--level-highlight);
    box-shadow: 0 0 0 1px rgba(0,212,255,0.35);
    transform: translateY(-2px);
}

.info-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--text-sub);
}

.info-value {
    font-size: 36px;
    font-weight: 700;
}

.info-subvalue {
    font-size: 11px;
    color: var(--text-sub);
}

/* PLAYERS & CHIPS */
.secondary-row {
    display: grid;
    grid-template-columns: 1.2fr 1.8fr;
    gap: 12px;
    margin-top: 8px;
}

.players-row {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.players-line {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
}

/* Viewer-mode spacing fix */
.viewer-mode .players-line {
    justify-content: flex-start !important;
    gap: 4px !important;
}

/* Prevent label from stretching */
.viewer-mode .players-label {
    min-width: auto !important;
    margin-right: 4px !important;
}

/* Prevent value from stretching to the far right */
.viewer-mode .players-value {
    flex: 0 0 auto !important;
}

.players-label {
    color: var(--text-sub);
    text-transform: uppercase;
    letter-spacing: 0.11em;
    font-size: 11px;
}

.players-value {
    font-weight: 700;
    font-size: 32px;
}


.average-stack {
    margin-top: 6px;
    font-size: 13px;
    color: var(--text-sub);
    text-transform: uppercase;
    letter-spacing: 0.12em;
}
.average-stack-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--accent);
}

/* CHIP CONFIG ‚Äì LARGE ICONS */
.chip-config-card {
    background: rgba(12,16,32,0.9);
    border-radius: 12px;
    padding: 10px 12px;
    border: 1px solid rgba(255,255,255,0.04);
    margin-top: 4px;
}
.chip-config-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
}
.chip-config-label-inline {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-sub);
}
.chip-config-row {
    display: grid;
    grid-template-columns: auto 1.2fr 1fr;
    gap: 6px;
    align-items: center;
    margin-bottom: 6px;
}
.chip-icon-preview {
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 80px;
}
.chip-config-row input[type="number"] {
    font-size: 24px;
}

/* QR PANEL */
.qr-panel {
    margin-top: 10px;
    padding: 10px;
    border-radius: 12px;
    border: 1px solid rgba(0,212,255,0.25);
    background: rgba(4,10,24,0.95);
    text-align: center;
    display: none;
}
.qr-panel h3 {
    margin: 0 0 6px;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: var(--accent);
}

/* BUTTONS */
.controls-row {
    display: flex;
    gap: 10px;
    margin-top: 16px;
    flex-wrap: wrap;
}

button {
    border: none;
    border-radius: 999px;
    padding: 8px 16px;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.16em;
    font-weight: 600;
    cursor: pointer;
    background: rgba(255,255,255,0.08);
    color: var(--text-main);
    transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), opacity var(--transition-fast);
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

button:hover:not(:disabled) {
    background: rgba(0,212,255,0.28);
    box-shadow: 0 0 0 1px rgba(0,212,255,0.4);
    transform: translateY(-1px);
}

button.primary {
    background: linear-gradient(135deg, #00d4ff, #007bff);
    color: #050609;
    box-shadow: 0 12px 24px rgba(0,123,255,0.35);
}

button.danger {
    background: rgba(255,75,92,0.16);
    color: #ffd8dd;
}

button.small {
    padding: 6px 10px;
    font-size: 11px;
    letter-spacing: 0.12em;
}

button.icon-only {
    padding-inline: 8px;
}

button:disabled {
    opacity: 0.35;
    cursor: default;
}

/* SOUND TOGGLE */
.sound-toggle {
    margin-left: 10px;
    cursor: pointer;
    font-size: 12px;
    padding: 6px 12px;
    border-radius: 999px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
}

/* LEVEL EDITOR */
.editor-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 10px;
}

.editor-body {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 230px;
    overflow-y: auto;
    padding-right: 4px;
}

.level-row {
    background: rgba(10,15,32,0.9);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.06);
    padding: 8px 10px;
    display: grid;
    grid-template-columns: auto 1.1fr 1.3fr 0.6fr auto;
    gap: 6px;
    align-items: center;
    font-size: 12px;
}

.level-row.current {
    background: rgba(0,212,255,0.14);
    box-shadow: 0 0 0 1px rgba(0,212,255,0.45);
}

.level-row.break-row {
    background: rgba(255,204,51,0.12);
    border-color: rgba(255,204,51,0.6);
}

.level-index {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-sub);
}

.level-row input {
    width: 100%;
    padding: 5px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(3,6,24,0.95);
    color: var(--text-main);
    font-size: 11px;
    text-align: center;
}

.level-actions {
    display: inline-flex;
    gap: 4px;
}

/* GENERIC FORM */
.config-row {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    flex-wrap: wrap;
    align-items: center;
    font-size: 12px;
}

input[type="number"],
input[type="text"],
select,
textarea {
    padding: 6px 8px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(3,6,24,0.95);
    color: var(--text-main);
    font-size: 12px;
}

textarea {
    width: 100%;
    min-height: 60px;
    resize: vertical;
}

.config-label {
    color: var(--text-sub);
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-size: 10px;
}

/* PRIZE / PAYOUT */
.prize-panel {
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid rgba(255,255,255,0.08);
}

.payout-row {
    display: grid;
    grid-template-columns: 70px 1fr auto;
    gap: 8px;
    align-items: center;
    background: rgba(7,12,28,0.85);
    padding: 6px 8px;
    border-radius: 8px;
    margin-bottom: 6px;
}

.payout-row input {
    padding: 6px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(3,6,24,0.95);
    color: var(--text-main);
    font-size: 12px;
}

.payout-display {
    font-size: 12px;
    color: var(--text-sub);
}

.payout-delete {
    background: rgba(255,75,92,0.2);
    color: #ffd8dd;
    padding: 4px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 11px;
}

/* SEAT DRAW */
.seat-draw-panel {
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid rgba(255,255,255,0.08);
}

.seat-draw-results {
    margin-top: 10px;
    max-height: 140px;
    overflow-y: auto;
    font-size: 12px;
}

.seat-draw-table {
    margin-bottom: 8px;
    padding: 8px 10px;
    border-radius: 10px;
    background: rgba(10,15,28,0.9);
    border: 1px solid rgba(255,255,255,0.08);
}

.seat-line {
    display: flex;
    justify-content: flex-start;
    gap: 12px;   /* adjust to taste */
}


/* PLAYERS EDITOR */
.players-editor-panel {
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid rgba(255,255,255,0.08);
}

.players-editor-list {
    margin-top: 8px;
    max-height: 160px;
    overflow-y: auto;
    font-size: 12px;
}

.player-edit-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 6px;
    align-items: center;
    padding: 4px 6px;
    border-radius: 8px;
    background: rgba(7,12,28,0.85);
    margin-bottom: 4px;
}

.player-edit-row.inactive {
    opacity: 0.6;
}

.player-active-label {
    font-size: 11px;
    color: var(--text-sub);
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

/* SUMMARY ROW */
.summary-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 10px;
    font-size: 12px;
}

.summary-item {
    background: rgba(10,15,28,0.85);
    border-radius: 999px;
    padding: 6px 10px;
    border: 1px solid rgba(255,255,255,0.08);
}
/* TOAST */
.toast {
    position: fixed;
    bottom: 18px;
    right: 18px;
    padding: 8px 14px;
    border-radius: 999px;
    background: rgba(3,13,32,0.94);
    border: 1px solid rgba(0,212,255,0.4);
    color: var(--text-main);
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 12px 24px rgba(0,0,0,0.6);
    opacity: 0;
    transform: translateY(18px);
    pointer-events: none;
    transition: opacity var(--transition-med), transform var(--transition-med);
}

.toast.visible {
    opacity: 1;
    transform: translateY(0);
}

/* RESPONSIVE */
@media (max-width: 900px) {
    .app-container { 
        grid-template-columns: 1fr; 
        max-width: 800px; 
    }
}
@media (max-width: 600px) {
    .info-row { 
        grid-template-columns: repeat(2, minmax(0,1fr)); 
    }
    .secondary-row { 
        grid-template-columns: 1fr; 
    }
}

/* LARGE SEAT DRAW (NEW TAB) */
.large-seat-body {
    background:#000;
    color:#fff;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    padding:20px;
}
.large-seat-title {
    font-size:60px;
    color:#00d4ff;
    margin-bottom:20px;
}
.large-seat-table {
    margin-bottom:40px;
    padding:20px;
    border:2px solid #00d4ff;
    border-radius:12px;
}
.large-seat-heading {
    font-size:36px;
    margin-bottom:16px;
}
.large-seat-line {
    display:flex;
    justify-content:space-between;
    font-size:42px;
    padding:6px 0;
}

/* VIEWER MODE ‚Äî BROADCAST LAYOUT */
.viewer-chip-bar {
    display: flex;
    gap: 12px;
    margin-top: 12px;
    justify-content: center;
    flex-wrap: wrap;
}

.viewer-chip {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 14px;
}

.viewer-chip-icon {
    width: 80px;
    height: 80px;
    font-size: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.viewer-chip-value {
    margin-top: 4px;
    font-size: 18px;
    font-weight: 600;
}

/* FULL-SCREEN DETAILS OVERLAY */
#detailsOverlay {
    position: fixed;
    inset: 0;
    background: var(--overlay-bg);
    backdrop-filter: blur(6px);
    z-index: 9999;
    display: none;
    flex-direction: column;
    padding: 20px;
    overflow-y: auto;
}

#detailsOverlay.visible {
    display: flex;
}

.details-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.details-title {
    font-size: 26px;
    font-weight: 700;
    color: var(--accent);
}

.details-close {
    font-size: 20px;
    padding: 6px 14px;
    border-radius: 999px;
    background: rgba(255,255,255,0.1);
    cursor: pointer;
}

.details-section {
    margin-top: 20px;
    background: rgba(12,16,32,0.9);
    padding: 16px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.08);
}

.details-section h4 {
    margin: 0 0 12px;
    font-size: 18px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--accent);
}

.details-blind-row,
.details-payout-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    font-size: 16px;
}

.details-blind-row:last-child,
.details-payout-row:last-child {
    border-bottom: none;
}

/* SIMPLE VIEW MODE */
.simple-view .panel:nth-child(2) {
    display: none;
}

.simple-view .controls-row,
.simple-view .summary-row {
    opacity: 0.3;
    pointer-events: none;
}

/* VIEWER MODE HIDES ALL CONTROLS */
/* Hide all buttons EXCEPT the viewer-mode details button */
.viewer-mode button:not(#btnShowDetails),
.viewer-mode input,
.viewer-mode select,
.viewer-mode textarea {
    pointer-events: none !important;
    opacity: 0.0 !important;
}

/* Allow payout inputs to remain editable in viewer mode */
.viewer-mode .payout-row input {
    pointer-events: auto !important;
    opacity: 1 !important;
}

.viewer-mode .qr-panel,
.viewer-mode .editor-body,
.viewer-mode .editor-header,
.viewer-mode .prize-panel,
.viewer-mode .seat-draw-panel,
.viewer-mode .players-editor-panel,
.viewer-mode .summary-row,
.viewer-mode .controls-row {
    display: none !important;
}

/* Allow payout editor to remain visible in viewer mode */
.viewer-mode .prize-panel {
    display: block !important;
    opacity: 1 !important;
    pointer-events: auto !important;
}

/* Allow payout editor body (percent mode) to remain visible in viewer mode */
.viewer-mode .editor-body {
    display: block !important;
    opacity: 1 !important;
    pointer-events: auto !important;
}


/* Allow info cards to remain visible in viewer mode */
.viewer-mode .info-card,
.viewer-mode .players-row,
.viewer-mode .players-line,
.viewer-mode .average-stack {
    opacity: 1 !important;
    pointer-events: none !important;
}


/* VIEWER MODE ‚Äî SHOW DETAILS BUTTON */
#btnShowDetails  {
    margin-top: 12px;
    padding: 10px 18px;
    font-size: 14px;
    letter-spacing: 0.12em;
    background: rgba(0,212,255,0.25);
    border: 1px solid rgba(0,212,255,0.4);
    border-radius: 999px;
    cursor: pointer;
    display: none;
}

.viewer-mode #btnShowDetails {
    display: inline-flex;
}
/* CHIP CONFIG ‚Äì LARGE ICONS */
.chip-config-card {
    /* your existing rules here */
}

/* ADD THIS ‚Äî chip icons inside details overlay */
.details-chip-item {
    display: flex;
    align-items: center;
gap: 8px;
    margin-bottom: 8px;
}


/* FIX ‚Äî scale SVG chips correctly in details overlay */
.details-chip-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.details-chip-icon svg {
    width: 100%;
    height: 100%;
}

/* SHOW the Players card in viewer mode */
.viewer-mode .secondary-row .info-card {
    display: flex !important;
}

/* HIDE only the chip config card */
.viewer-mode #chipConfigCard {
    display: none !important;
}

/* Fix spacing: stop players-row from pushing items apart */
.viewer-mode .players-row {
    justify-content: flex-start !important;
    gap: 8px !important; /* adjust as needed */
}

/* Keep each label/value pair tight */
.viewer-mode .players-line {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Optional: shrink the label width so it doesn't push the number away */
.viewer-mode .players-label {
    min-width: auto;
    margin-right: 4px;
}


</style>


<!-- QR library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<!-- Firebase compat libraries -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>
<div class="app-container" id="appContainer">

    <!-- LEFT SIDE (TIMER + VIEWER CHIP BAR + SHOW DETAILS BUTTON) -->
    <div class="panel" id="leftPanel">
        <div class="panel-inner main-timer">

            <div class="timer-top-row">
                <div>
                    <input id="editableTitle" value="Hold Em Tournament Timer">
                    <h2>Blinds structure & live level timer</h2>
                </div>
                <button id="soundToggle" class="sound-toggle">üîä Sound: ON</button>
            </div>

            <div class="timer-display" id="timerDisplay">
                <div class="timer-display-inner">
                    <div class="time-remaining-label" id="timeLabel">Time remaining</div>
                    <div class="time-remaining-value" id="timeRemaining">00:00</div>
                    <div class="level-badge" id="levelBadge">
                        Level <span id="currentLevelNumber">1</span> ‚Ä¢
                        <span id="currentLevelMinutes">20</span> min
                    </div>
                </div>
            </div>

            <!-- INFO CARDS -->
            <div class="info-row">
                <div class="info-card highlight" id="currentBlindsCard">
                    <div class="info-label">Current</div>
                    <div class="info-value" id="currentBlinds">25 / 50</div>
                </div>
                <div class="info-card" id="nextBlindsCard">
                    <div class="info-label">Next</div>
                    <div class="info-value" id="nextBlinds">50 / 100</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Progress</div>
                    <div class="info-value" id="levelProgress">0%</div>
                    <div class="info-subvalue" id="levelsCountInfo">Level 1 of 1</div>
                </div>
            </div>

            <!-- PLAYERS + CHIPS -->
            <div class="secondary-row">
                <div class="info-card">
                    <div class="info-label">Players</div>
                    <div class="players-row">
                        <div class="players-line">
                            <span class="players-label">Entered</span>
                            <span class="players-value" id="playersEntered">10</span>
                        </div>
                        <div class="players-line">
                            <span class="players-label">Remaining</span>
                            <span class="players-value" id="playersRemaining">10</span>
                        </div>
                        <div class="average-stack">
                            Avg Stack:
                            <span class="average-stack-value" id="avgStack">0</span>
                        </div>
                    </div>
                </div>

                <!-- CHIP CONFIG (Controller) -->
                <div class="chip-config-card" id="chipConfigCard">
                    <div class="chip-config-header">
                        <div class="info-label">Chip colors & values</div>
                        <div>
                            <span class="chip-config-label-inline">Icon style</span>
                            <select id="chipIconModeSelect" style="width:90px;">
                                <option value="emoji">Emoji</option>
                                <option value="svg">SVG</option>
                            </select>
                        </div>
                    </div>

                    <div class="config-row" style="margin-top:4px;">
                        <div>
                            <span class="chip-config-label-inline"># of chip colors</span>
                            <select id="numChipsSelect" style="width:70px;">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3" selected>3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>

                    <div id="chipConfigRows" style="margin-top:8px;"></div>
                </div>
            </div>

            <!-- VIEWER CHIP BAR (always visible in viewer mode) -->
            <div id="viewerChipBar" class="viewer-chip-bar" style="display:none;"></div>

            <!-- SHOW DETAILS BUTTON (viewer mode only) -->
            <button id="btnShowDetails">Show Details</button>
<button id="btnToggleSimple">Simple View</button>


            <!-- CONTROLS -->
            <div class="controls-row">
                <button class="primary" id="btnStartPause">‚ñ∂ Start</button>
                <button id="btnReset">‚èÆ Reset</button>
                <button id="btnPrevLevel" class="small">‚¨Ö Prev</button>
                <button id="btnNextLevel" class="small">Next ‚û°</button>
            </div>

            <div class="controls-row">
                <div>
                    <div class="config-label">Players entered</div>
                    <input id="inputPlayersEntered" type="number" min="0" value="10" style="width:80px;">
                </div>
                <div>
                    <div class="config-label">Starting stack</div>
                    <input id="inputStartingStack" type="number" min="1" value="10000" style="width:100px;">
                </div>
                <div>
                    <div class="config-label">Level length (min)</div>
                    <input id="inputLevelLength" type="number" min="1" value="20" style="width:80px;">
                </div>
                <div>
                    <div class="config-label">Duration (hrs)</div>
                    <input id="inputDuration" type="number" min="1" step="0.5" value="4" style="width:80px;">
                </div>
            </div>

            <div class="controls-row">
                <div>
                    <div class="config-label">Break every N levels</div>
                    <input id="inputBreakFrequency" type="number" min="1" value="3" style="width:60px;">
                </div>
                <div>
                    <div class="config-label">Break length (min)</div>
                    <input id="inputBreakMinutes" type="number" min="1" value="10" style="width:60px;">
                </div>
                <div>
                   <div class="config-label">Stop 25‚Äëincrements when SB reaches</div>
<input id="inputSwitchSB" type="number" min="25" value="100" style="width:80px;">

                </div>
                <button id="btnSuggestBlinds" class="small">Suggest Blinds</button>
            </div>

            <!-- QR toggle -->
            <div class="controls-row">
                <button id="btnToggleQR" class="small">üì± Show QR Code</button>
            </div>
            <div class="qr-panel" id="qrPanel">
                <h3>Scan to open clock</h3>
                <canvas id="qrCanvas" width="180" height="180" style="margin-top:4px;"></canvas>
            </div>

            <div class="summary-row">
                <div class="summary-item" id="summaryEntryFee">Entry: $0</div>
                <div class="summary-item" id="summaryPrizePool">Prize pool: $0</div>
                <div class="summary-item" id="summaryPayouts">Payouts: 0 spots</div>
            </div>

        </div>
    </div>

    <!-- RIGHT SIDE (CONTROLLER ONLY) -->
    <div class="panel" id="rightPanel">
        <div class="panel-inner">
            <div class="editor-header">
                <div>
                    <h2>Tournament structure</h2>
                    <h3>Levels & breaks</h3>
                </div>
                <div>
                    <button id="btnAddLevel" class="small">Ôºã Add level</button>
                    <button id="btnInsertBreak" class="small">‚òï Insert break</button>
                </div>
            </div>

            <div class="editor-body" id="levelsContainer"></div>

            <div class="config-row">
                <div>
                    <div class="config-label">Config name</div>
                    <input type="text" id="configName" placeholder="My Home Game">
                </div>
                <div>
                    <div class="config-label">Saved structures</div>
                    <select id="savedConfigs">
                        <option value="">Load structure‚Ä¶</option>
                    </select>
                </div>
            </div>

            <div class="config-row">
                <button id="btnSaveConfig">üíæ Save</button>
                <button id="btnLoadConfig">üìÇ Load</button>
                <button id="btnDeleteConfig" class="danger small">üóë Delete</button>
                <button id="btnLoadDefault" class="small">‚ôª Default</button>
            </div>

            <div class="prize-panel">
                <h3>Prize pool & payouts</h3>

                <div class="config-row">
                    <div>
                        <div class="config-label">Entry fee</div>
                        <input type="number" id="inputEntryFee" placeholder="e.g. 50" style="width:120px;">
                    </div>
                    <div>
                        <div class="config-label">Total prize money</div>
                        <input type="number" id="inputPrizeMoney" placeholder="auto" style="width:140px;" disabled>
                    </div>
                    <div>
                        <div class="config-label">Number of payouts</div>
                        <input type="number" id="inputNumPayouts" value="3" min="1" style="width:80px;">
                    </div>
                </div>
<div class="config-row">
    <div class="config-label">Payout mode</div>
    <select id="payoutMode" style="width:140px;">
        <option value="percent">Percent</option>
        <option value="fixed">Fixed Amounts</option>
    </select>
</div>


                <div class="config-row">
                    <button id="btnRegenPayouts" class="small">‚Üª Regenerate model A payouts</button>
                </div>

                <div id="payoutList" style="margin-top:10px; max-height:160px; overflow-y:auto;"></div>
            </div>

            <div class="seat-draw-panel">
                <h3>Random seat draw</h3>
                <div class="config-row">
                    <div>
                        <div class="config-label">Tables</div>
                        <input type="number" id="inputTables" value="2" min="1" style="width:60px;">
                    </div>
                    <div>
                        <div class="config-label">Seats/table</div>
                        <input type="number" id="inputSeatsPerTable" value="9" min="1" style="width:70px;">
                    </div>
                    <div>
                        <div class="config-label">Players used</div>
                        <span style="font-size:11px;color:var(--text-sub);">Active players only</span>
                    </div>
                </div>
                <div class="config-row">
                    <button id="btnSeatDraw">üé≤ Generate seat draw</button>
                </div>

<div class="config-row">
    <button id="btnOpenUpdatedSeatDraw">Open updated seat draw in new tab</button>
</div>


<div class="move-player-controls">
    <label>Move player from table:</label>
    <select id="moveFromTable"></select>

    <label>to table:</label>
    <select id="moveToTable"></select>

    <button id="btnMovePlayer">Move Random Player</button>
</div>


                <div class="seat-draw-results" id="seatDrawResults"></div>
            </div>

            <div class="players-editor-panel">
                <h3>Players (names & busted)</h3>
                <div class="config-row">
                    <button id="btnSyncPlayersCount" class="small">‚Üª Sync with players entered</button>
                    <span style="font-size:11px;color:var(--text-sub);">Uncheck to mark busted.</span>
                </div>
                <div class="players-editor-list" id="playersEditor"></div>
            </div>
        </div>
    </div>

</div>

<!-- FULL-SCREEN DETAILS OVERLAY -->
<div id="detailsOverlay">
    <div class="details-header">
        <div class="details-title">Tournament Details</div>
        <div class="details-close" id="detailsClose">‚úï</div>
    </div>

    <div class="details-section" id="detailsChipSection">
        <h4>Chip Values</h4>
        <div id="detailsChipList"></div>
    </div>

    <div class="details-section" id="detailsBlindSection">
        <h4>Blind Schedule</h4>
        <div id="detailsBlindList"></div>
    </div>

    <div class="details-section" id="detailsPayoutSection">
        <h4>Payout Structure</h4>
        <div id="detailsPayoutList"></div>
    </div>
</div>

<audio id="levelBeep"></audio>
<audio id="warningBeep"></audio>

<div class="toast" id="toast"></div>


<script>

let seatAssignments = [];


function renderDetailsChipSection() {
    const container = document.getElementById("detailsChipList");
    container.innerHTML = "";

    chipConfigs.forEach(cfg => {
        const row = document.createElement("div");
        row.className = "details-chip-item";

        const icon = document.createElement("div");
        icon.className = "details-chip-icon";
        icon.innerHTML = chipIconMode === "emoji"
    ? getEmojiChip(cfg.color)
    : getSvgChip(cfg.color, cfg.value)
;



        const val = document.createElement("div");
        val.textContent = `$${cfg.value}`;

        row.appendChild(icon);
        row.appendChild(val);
        container.appendChild(row);
    });
}

/* ---------------------------------------------------------
   FIREBASE INITIALIZATION
--------------------------------------------------------- */
const firebaseConfig = {
    apiKey: "AIzaSyC6PE5Ta0l5YIlqnSRvJSvwX0Tzv-MkZLw",
    authDomain: "hold-em-tournament-live-feed.firebaseapp.com",
    projectId: "hold-em-tournament-live-feed",
    storageBucket: "hold-em-tournament-live-feed.firebasestorage.app",
    messagingSenderId: "206496617680",
    appId: "1:206496617680:web:6312034c2e5e92b1f7fad5",
    measurementId: "G-5992ZNDY8R",
    databaseURL: "https://hold-em-tournament-live-feed-default-rtdb.firebaseio.com/"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------------------------------------------------------
   MODE & TOURNAMENT ID HANDLING
--------------------------------------------------------- */
const urlParams = new URLSearchParams(window.location.search);
let tournamentId = urlParams.get("tournament");
let mode = urlParams.get("mode") || "control"; // control or view

// Option B: Keep same ID unless user clicks "New Tournament"
if (!tournamentId) {
    // Load from localStorage if exists
    const savedId = localStorage.getItem("tournamentId");
    if (savedId) {
        tournamentId = savedId;
    } else {
        tournamentId = Math.random().toString(36).slice(2, 8).toUpperCase();
        localStorage.setItem("tournamentId", tournamentId);
    }
}

document.title = `Hold Em Tournament Timer ‚Äì ${tournamentId}`;
// If QR panel is already open, regenerate QR now that tournamentId is ready




/* ---------------------------------------------------------
   DOM ELEMENTS
--------------------------------------------------------- */
const appContainer = document.getElementById("appContainer");
const leftPanel = document.getElementById("leftPanel");
const rightPanel = document.getElementById("rightPanel");

const editableTitle = document.getElementById("editableTitle");
const timerDisplay = document.getElementById("timerDisplay");
const timeRemainingEl = document.getElementById("timeRemaining");
const timeLabel = document.getElementById("timeLabel");
const levelBadge = document.getElementById("levelBadge");
const currentLevelNumberEl = document.getElementById("currentLevelNumber");
const currentLevelMinutesEl = document.getElementById("currentLevelMinutes");

const currentBlindsEl = document.getElementById("currentBlinds");
const nextBlindsEl = document.getElementById("nextBlinds");
const levelProgressEl = document.getElementById("levelProgress");
const levelsCountInfoEl = document.getElementById("levelsCountInfo");

const playersEnteredEl = document.getElementById("playersEntered");
const playersRemainingEl = document.getElementById("playersRemaining");
const avgStackEl = document.getElementById("avgStack");

const inputPlayersEntered = document.getElementById("inputPlayersEntered");
const inputStartingStack = document.getElementById("inputStartingStack");
const inputLevelLength = document.getElementById("inputLevelLength");
const inputDuration = document.getElementById("inputDuration");
const inputBreakFrequency = document.getElementById("inputBreakFrequency");
const inputBreakMinutes = document.getElementById("inputBreakMinutes");
const inputSwitchBB = document.getElementById("inputSwitchBB");

const chipIconModeSelect = document.getElementById("chipIconModeSelect");
const numChipsSelect = document.getElementById("numChipsSelect");
const chipConfigRows = document.getElementById("chipConfigRows");

const btnStartPause = document.getElementById("btnStartPause");
const btnReset = document.getElementById("btnReset");
const btnPrevLevel = document.getElementById("btnPrevLevel");
const btnNextLevel = document.getElementById("btnNextLevel");
const btnSuggestBlinds = document.getElementById("btnSuggestBlinds");
const btnToggleQR = document.getElementById("btnToggleQR");
const btnToggleSimple = document.getElementById("btnToggleSimple");

const qrPanel = document.getElementById("qrPanel");
const qrCanvas = document.getElementById("qrCanvas");

const summaryEntryFee = document.getElementById("summaryEntryFee");
const summaryPrizePool = document.getElementById("summaryPrizePool");
const summaryPayouts = document.getElementById("summaryPayouts");

const levelsContainer = document.getElementById("levelsContainer");

const configName = document.getElementById("configName");
const savedConfigs = document.getElementById("savedConfigs");
const btnSaveConfig = document.getElementById("btnSaveConfig");
const btnLoadConfig = document.getElementById("btnLoadConfig");
const btnDeleteConfig = document.getElementById("btnDeleteConfig");
const btnLoadDefault = document.getElementById("btnLoadDefault");

const inputEntryFee = document.getElementById("inputEntryFee");
const inputPrizeMoney = document.getElementById("inputPrizeMoney");
const inputNumPayouts = document.getElementById("inputNumPayouts");
const btnRegenPayouts = document.getElementById("btnRegenPayouts");
const payoutList = document.getElementById("payoutList");

const inputTables = document.getElementById("inputTables");
const inputSeatsPerTable = document.getElementById("inputSeatsPerTable");
const btnSeatDraw = document.getElementById("btnSeatDraw");
const seatDrawResults = document.getElementById("seatDrawResults");

const btnSyncPlayersCount = document.getElementById("btnSyncPlayersCount");
const playersEditor = document.getElementById("playersEditor");

const viewerChipBar = document.getElementById("viewerChipBar");
const btnShowDetails = document.getElementById("btnShowDetails");

const detailsOverlay = document.getElementById("detailsOverlay");
const detailsClose = document.getElementById("detailsClose");
const detailsChipList = document.getElementById("detailsChipList");
const detailsBlindList = document.getElementById("detailsBlindList");
const detailsPayoutList = document.getElementById("detailsPayoutList");

const toastEl = document.getElementById("toast");
const soundToggle = document.getElementById("soundToggle");

const levelBeep = document.getElementById("levelBeep");
const warningBeep = document.getElementById("warningBeep");

/* ---------------------------------------------------------
   CONTROL VIEW LISTENERS FOR AVERAGE STACK
--------------------------------------------------------- */

// When the starting stack changes, recalc + sync
inputStartingStack.addEventListener("input", () => {
    startingStack = parseInt(inputStartingStack.value, 10) || 0;  // ‚Üê add this line
    updateAverageStack();
    pushStateToFirebase();
});

// When players entered changes, rebuild players + recalc + sync
inputPlayersEntered.addEventListener("input", () => {
    createPlayersFromEntered();
    updateAverageStack();
    pushStateToFirebase();
});


/* ---------------------------------------------------------
   QR REGEN AFTER DOM IS READY
--------------------------------------------------------- */
if (qrPanel && getComputedStyle(qrPanel).display !== "none") {
    initQRCode();
}

/* ---------------------------------------------------------
   GLOBAL STATE
--------------------------------------------------------- */

let levels = [];
let currentLevelIndex = 0;
let timerSecondsLeft = 0;
let timerTotalSeconds = 0;
let timerInterval = null;
let warningPlayedThisLevel = false;

let players = [];
let startingStack = 0;

let chipConfigs = [];
let chipIconMode = "emoji";
let numChipColors = 3;

let payouts = [];

let qrInstance = null;

/* ---------------------------------------------------------
   APPLY STATE FROM FIREBASE (VIEWER MODE)
--------------------------------------------------------- */
function applyStateFromFirebase(data) {
    if (!data) return;

    // Players
    players = data.players || [];
    playersEnteredEl.textContent = data.playersEntered ?? players.length;
    playersRemainingEl.textContent = data.playersRemaining ?? players.filter(p => p.active).length;

    // Chip configs (optional but safe)
    chipConfigs = data.chipConfigs || [];
    chipIconMode = data.chipIconMode || "emoji";
    renderViewerChipBar();
renderDetailsChipSection();
startingStack = data.startingStack ?? startingStack;
updateAverageStack();


}


/* ---------------------------------------------------------
   UTILITY FUNCTIONS
--------------------------------------------------------- */
function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add("visible");
    setTimeout(() => toastEl.classList.remove("visible"), 3000);
}

function formatTime(sec) {
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return `${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}

function playChime(type) {
    if (soundToggle.dataset.enabled === "false") return;
    if (type === "warning") warningBeep.play();
    else levelBeep.play();
}

/* ---------------------------------------------------------
   CHIP ICON RENDERING
--------------------------------------------------------- */
function getSvgChip(color, value) {
    return `
    <svg width="80" height="80" viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="45" fill="${color}" stroke="#fff" stroke-width="4"/>
        <circle cx="50" cy="50" r="25" fill="rgba(255,255,255,0.85)"/>
        <text x="50" y="57" text-anchor="middle"
              font-size="28" font-weight="bold" fill="#000">
            ${value}
        </text>
    </svg>`;
}

function getEmojiChip(color) {
    // normalize like "#ff0000" -> "ff0000"
    const hex = color.replace("#", "").trim();
    if (hex.length !== 6) return "‚ö™";

    const r = parseInt(hex.slice(0, 2), 16) / 255;
    const g = parseInt(hex.slice(2, 4), 16) / 255;
    const b = parseInt(hex.slice(4, 6), 16) / 255;

    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    const l = (max + min) / 2;

    // handle gray/white/black-ish
    const delta = max - min;
    if (delta < 0.05) {
        if (l < 0.2) return "‚ö´";  // very dark
        if (l > 0.8) return "‚ö™";  // very light
        // mid-gray, pick white as default
        return "‚ö™";
    }

    // compute hue in degrees
    let h;
    if (max === r) {
        h = ((g - b) / delta) % 6;
    } else if (max === g) {
        h = (b - r) / delta + 2;
    } else {
        h = (r - g) / delta + 4;
    }
    h = Math.round(h * 60);
    if (h < 0) h += 360;

    // map hue -> emoji
    if (h >= 330 || h < 30) return "üî¥";      // red
    if (h >= 30 && h < 90) return "üü°";       // yellow
    if (h >= 90 && h < 150) return "üü¢";      // green
    if (h >= 150 && h < 240) return "üîµ";     // blue/cyan
    if (h >= 240 && h < 300) return "üü£";     // purple
    if (h >= 300 && h < 330) return "üü†";     // orange-ish / pink-ish

    return "üü¢"; // fallback
}

function renderChipConfig() {
    chipConfigRows.innerHTML = "";
    for (let i = 0; i < numChipColors; i++) {
        const cfg = chipConfigs[i] || { color: "#ffffff", value: 0 };
        const row = document.createElement("div");
        row.className = "chip-config-row";

        const icon = document.createElement("div");
        icon.className = "chip-icon-preview";
       icon.innerHTML = chipIconMode === "emoji"
    ? getEmojiChip(cfg.color)
    : getSvgChip(cfg.color, cfg.value);


        const colorInput = document.createElement("input");
        colorInput.type = "color";
        colorInput.value = cfg.color;

        const valueInput = document.createElement("input");
        valueInput.type = "number";
        valueInput.value = cfg.value;

        colorInput.addEventListener("input", () => {
            cfg.color = colorInput.value;
            chipConfigs[i] = cfg;

          icon.innerHTML = chipIconMode === "emoji"
    ? getEmojiChip(cfg.color)
    : getSvgChip(cfg.color, cfg.value);


            pushStateToFirebase();
            renderViewerChipBar();
        });

        valueInput.addEventListener("input", () => {
            cfg.value = parseInt(valueInput.value) || 0;
            chipConfigs[i] = cfg;
            pushStateToFirebase();
            renderViewerChipBar();
        });

        row.appendChild(icon);
        row.appendChild(colorInput);
        row.appendChild(valueInput);
        chipConfigRows.appendChild(row);
    }
}

/* ---------------------------------------------------------
   VIEWER CHIP BAR RENDERING
--------------------------------------------------------- */
function renderViewerChipBar() {
    viewerChipBar.innerHTML = "";

    chipConfigs.forEach(cfg => {
        const chip = document.createElement("div");
        chip.className = "viewer-chip";

        chip.innerHTML = chipIconMode === "emoji"
            ? getEmojiChip(cfg.color)
            : getSvgChip(cfg.color, cfg.value);

        viewerChipBar.appendChild(chip);
    });
}


/* ---------------------------------------------------------
   DETAILS OVERLAY (BLIND SCHEDULE + PAYOUTS)
--------------------------------------------------------- */
function openDetailsOverlay() {
    renderDetailsOverlay();      // full details (chips + blinds + payouts, with correct numbering)
    detailsOverlay.classList.add("visible");
}


function closeDetailsOverlay() {
    detailsOverlay.classList.remove("visible");
}

detailsClose.addEventListener("click", closeDetailsOverlay);
btnShowDetails.addEventListener("click", openDetailsOverlay);
btnToggleSimple.addEventListener("click", () => {
    appContainer.classList.toggle("simple-view");
    btnToggleSimple.textContent =
        appContainer.classList.contains("simple-view")
        ? "Full View"
        : "Simple View";
});


/* ---------------------------------------------------------
   LEVEL RENDERING
--------------------------------------------------------- */
function renderLevels() {
    levelsContainer.innerHTML = "";

let realLevelNumber = 0;

    levels.forEach((lvl, i) => {
    if (lvl.type === "level") {
        realLevelNumber++;
        lvl.displayNumber = realLevelNumber;
    } else {
        lvl.displayNumber = "Break";
    }
console.log("ROW", i, "type:", lvl.type, "displayNumber:", lvl.displayNumber, "sb:", lvl.sb, "bb:", lvl.bb);


        const row = document.createElement("div");
        row.className = "level-row";
        if (i === currentLevelIndex) row.classList.add("current");
        if (lvl.type === "break") row.classList.add("break-row");

        const idx = document.createElement("div");
        idx.className = "level-index";
       idx.textContent = lvl.type === "break" ? "Break" : `L${lvl.displayNumber}`;


        const sb = document.createElement("input");
        sb.type = "number";
        sb.value = lvl.sb;
        sb.disabled = lvl.type === "break";

        const bb = document.createElement("input");
        bb.type = "number";
        bb.value = lvl.bb;
        bb.disabled = lvl.type === "break";

        const ante = document.createElement("input");
        ante.type = "number";
        ante.value = lvl.ante;
        ante.disabled = lvl.type === "break";

        const mins = document.createElement("input");
        mins.type = "number";
        mins.value = lvl.minutes;

        sb.addEventListener("input", () => { lvl.sb = parseInt(sb.value)||0; pushStateToFirebase(); });
        bb.addEventListener("input", () => { lvl.bb = parseInt(bb.value)||0; pushStateToFirebase(); });
        ante.addEventListener("input", () => { lvl.ante = parseInt(ante.value)||0; pushStateToFirebase(); });
        mins.addEventListener("input", () => { lvl.minutes = parseInt(mins.value)||1; pushStateToFirebase(); });

        const actions = document.createElement("div");
        actions.className = "level-actions";

        const del = document.createElement("button");
        del.className = "small danger";
        del.textContent = "‚úï";
        del.addEventListener("click", () => {
            levels.splice(i,1);
            if (currentLevelIndex >= levels.length) currentLevelIndex = levels.length-1;
            renderLevels();
            pushStateToFirebase();
        });

        actions.appendChild(del);

        row.appendChild(idx);
        row.appendChild(sb);
        row.appendChild(bb);
        row.appendChild(ante);
        row.appendChild(mins);
        row.appendChild(actions);

        levelsContainer.appendChild(row);
    });

const totalRealLevels = levels.filter(l => l.type === "level").length;
const currentRealLevel = levels[currentLevelIndex]?.displayNumber || 1;

levelsCountInfoEl.textContent = `Level ${currentRealLevel} of ${totalRealLevels}`;

}

/* ---------------------------------------------------------
   LEVEL NAVIGATION
--------------------------------------------------------- */
function initLevel(index) {
    if (!levels[index]) return;

    const lvl = levels[index];
    currentLevelNumberEl.textContent = index + 1;
    currentLevelMinutesEl.textContent = lvl.minutes;



    currentBlindsEl.textContent = lvl.type === "break"
        ? "BREAK"
        : `${lvl.sb} / ${lvl.bb}${lvl.ante ? " / " + lvl.ante : ""}`;

    const next = levels[index+1];
    nextBlindsEl.textContent = next
        ? (next.type === "break"
            ? "BREAK"
            : `${next.sb} / ${next.bb}${next.ante ? " / " + next.ante : ""}`)
        : "--";

    timerDisplay.classList.toggle("break-mode", lvl.type === "break");

    renderLevels();
    updateTimerDisplay();
    if (mode === "control") {
    pushStateToFirebase();
}

}

function goToNextLevel(fromTimer=false) {
    if (currentLevelIndex < levels.length - 1) {
        currentLevelIndex++;

        // Reset timer here ‚Äî ONLY when changing levels
        const lvl = levels[currentLevelIndex];
        timerTotalSeconds = lvl.minutes * 60;
        timerSecondsLeft = timerTotalSeconds;
        warningPlayedThisLevel = false;

        initLevel(currentLevelIndex);

        if (!fromTimer) showToast("Moved to next level");
    }
}

function goToPrevLevel() {
    if (currentLevelIndex > 0) {
        currentLevelIndex--;

        // Reset timer here ‚Äî ONLY when changing levels
        const lvl = levels[currentLevelIndex];
        timerTotalSeconds = lvl.minutes * 60;
        timerSecondsLeft = timerTotalSeconds;
        warningPlayedThisLevel = false;

        initLevel(currentLevelIndex);
        showToast("Moved to previous level");
    }
}

/* ---------------------------------------------------------
   TIMER LOGIC
--------------------------------------------------------- */
function updateTimerDisplay() {
    timeRemainingEl.textContent = formatTime(timerSecondsLeft);
    const pct = Math.floor((1 - timerSecondsLeft / timerTotalSeconds) * 100);
    levelProgressEl.textContent = `${pct}%`;
}

function tick() {
    if (timerSecondsLeft > 0) {
        timerSecondsLeft--;

        if (!warningPlayedThisLevel && timerSecondsLeft === 60) {
            warningPlayedThisLevel = true;
            playChime("warning");
            const lvl = levels[currentLevelIndex];
            showToast(lvl.type === "break" ? "1 minute left in break." : "1 minute left in level.");
        }

        updateTimerDisplay();
        pushStateToFirebase();
    } else {
        pauseTimer();
        playChime("level");
        goToNextLevel(true);
    }
}

function startTimer() {
    // Prevent double-start
    if (timerInterval) return;

    // If timer hasn't been initialized for this level, set it now
    if (timerSecondsLeft <= 0) {
        const lvl = levels[currentLevelIndex];
        timerTotalSeconds = lvl.minutes * 60;
        timerSecondsLeft = timerTotalSeconds;
        warningPlayedThisLevel = false;
        updateTimerDisplay();
    }

    timerInterval = setInterval(tick, 1000);
    btnStartPause.textContent = "‚è∏ Pause";
}


function pauseTimer() {
    clearInterval(timerInterval);
    timerInterval = null;
    btnStartPause.textContent = "‚ñ∂ Start";
}

function resetTimer() {
    const lvl = levels[currentLevelIndex];
    timerTotalSeconds = lvl.minutes * 60;
    timerSecondsLeft = timerTotalSeconds;
    warningPlayedThisLevel = false;
    updateTimerDisplay();
    pushStateToFirebase();
}

/* ---------------------------------------------------------
   PLAYERS
--------------------------------------------------------- */
function createPlayersFromEntered() {
    const count = parseInt(inputPlayersEntered.value) || 0;
    players = [];
    for (let i = 0; i < count; i++) {
        players.push({ id: i+1, name: `Player ${i+1}`, active: true });
    }
    playersEnteredEl.textContent = count;
    playersRemainingEl.textContent = count;
    updateAverageStack();
    renderPlayersEditor();
    pushStateToFirebase();
}

function renderPlayersEditor() {
    playersEditor.innerHTML = "";
    players.forEach((p, i) => {
        const row = document.createElement("div");
        row.className = "player-edit-row";
        if (!p.active) row.classList.add("inactive");

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.value = p.name;

        const activeToggle = document.createElement("input");
        activeToggle.type = "checkbox";
        activeToggle.checked = p.active;

        nameInput.addEventListener("input", () => {
            p.name = nameInput.value;
            pushStateToFirebase();
        });

        activeToggle.addEventListener("change", () => {
            p.active = activeToggle.checked;
            row.classList.toggle("inactive", !p.active);
            playersRemainingEl.textContent = players.filter(x => x.active).length;
            updateAverageStack();

            // ‚≠ê‚≠ê‚≠ê NEW LOGIC ‚Äî REMOVE INACTIVE PLAYER FROM SEAT ASSIGNMENTS ‚≠ê‚≠ê‚≠ê
            if (!p.active) {
                seatAssignments = seatAssignments.filter(a => a.player !== p);
                renderSeatDrawFromAssignments();
            }
            // ‚≠ê‚≠ê‚≠ê END NEW LOGIC ‚≠ê‚≠ê‚≠ê

            pushStateToFirebase();
        });

        const label = document.createElement("label");
        label.className = "player-active-label";
        label.appendChild(activeToggle);
        label.append(" Active");

        row.appendChild(nameInput);
        row.appendChild(label);
        playersEditor.appendChild(row);
    });
}

function updateAverageStack() {
    const remaining = players.filter(p => p.active).length;

    // In viewer mode, NEVER read from hidden inputs
    const starting = (mode === "view")
        ? (typeof startingStack === "number" ? startingStack : 0)
        : (parseInt(inputStartingStack.value) || 0);

    const totalChips = players.length * starting;
    const avg = remaining > 0 ? Math.floor(totalChips / remaining) : 0;

    avgStackEl.textContent = avg;
}

/* ---------------------------------------------------------
   PAYOUTS
--------------------------------------------------------- */
function regeneratePayoutsFromModel() {
    const num = parseInt(inputNumPayouts.value) || 0;
    payouts = [];

    // Model A: descending percentages that sum to 100%
    const base = 100;
    let remaining = base;
    let totalWeight = 0;

    // Weighting: 1st gets most, last gets least
    for (let i = 1; i <= num; i++) {
        totalWeight += (num - i + 1);
    }

    for (let i = 1; i <= num; i++) {
        const weight = (num - i + 1);
        const pct = Math.round((weight / totalWeight) * 100);
        payouts.push({ place: i, percent: pct, amount: 0 });
    }

    // Fix rounding to exactly 100%
    let sum = payouts.reduce((a,p) => a + p.percent, 0);
    if (sum !== 100) {
        payouts[0].percent += (100 - sum);
    }

    renderPayouts();
    updatePrizePool();
    pushStateToFirebase();
}

function normalizePayoutPercents() {
    let sum = payouts.reduce((a,p) => a + p.percent, 0);
    if (sum === 100) return;

    const diff = 100 - sum;
    payouts[0].percent += diff;
}

function renderPayouts() {
    payoutList.innerHTML = "";

    payouts.forEach((p, i) => {
        const row = document.createElement("div");
        row.className = "payout-row";

        const place = document.createElement("div");
        place.textContent = `${p.place}${p.place===1?"st":p.place===2?"nd":p.place===3?"rd":"th"}`;

      const valueInput = document.createElement("input");
valueInput.type = "number";

// Percent mode
if (payoutMode.value === "percent") {
    valueInput.value = p.percent;
    valueInput.addEventListener("input", () => {
        p.percent = parseInt(valueInput.value) || 0;
        normalizePayoutPercents();
        updatePrizePool();
        renderPayouts();
        pushStateToFirebase();
    });

// Fixed amount mode
} else {
    valueInput.value = p.amount;
    valueInput.addEventListener("input", () => {
        p.amount = parseInt(valueInput.value) || 0;
        updatePrizePool();
        pushStateToFirebase();
    });
}

const del = document.createElement("div");
del.className = "payout-delete";
del.textContent = "‚úï";
del.addEventListener("click", () => {
    payouts.splice(i,1);
    payouts.forEach((x, idx) => x.place = idx+1);
    normalizePayoutPercents();
    renderPayouts();
    updatePrizePool();
    pushStateToFirebase();
});

row.appendChild(place);
row.appendChild(valueInput);
row.appendChild(del);
payoutList.appendChild(row);

    });

    summaryPayouts.textContent = `Payouts: ${payouts.length} spots`;
}

function updatePrizePool() {
   const entry = parseFloat(inputEntryFee.value) || 0;
const count = players.length; // more accurate than inputPlayersEntered
let pool;

if (payoutMode.value === "percent") {
    pool = entry * count;
    payouts.forEach(p => {
        p.amount = Math.round(pool * (p.percent / 100));
    });
} else {
    pool = payouts.reduce((a, p) => a + (p.amount || 0), 0);
}

inputPrizeMoney.value = pool;
summaryEntryFee.textContent = `Entry: $${entry}`;
summaryPrizePool.textContent = `Prize pool: $${pool}`;

pushStateToFirebase();

}

/* ---------------------------------------------------------
   SEAT DRAW
--------------------------------------------------------- */
function generateSeatDraw() {
    const tables = parseInt(inputTables.value) || 1;
    const seats = parseInt(inputSeatsPerTable.value) || 1;

    const activePlayers = players.filter(p => p.active);
    const shuffled = [...activePlayers].sort(() => Math.random() - 0.5);

seatAssignments = []; // reset

let assignIndex = 0;
for (let t = 1; t <= tables; t++) {
    for (let s = 1; s <= seats; s++) {
        if (assignIndex >= shuffled.length) break;
        const p = shuffled[assignIndex++];

        seatAssignments.push({
            table: t,
            seat: s,
            player: p
        });
    }
}


  // --- EXISTING ON-PAGE RENDER ---
seatDrawResults.innerHTML = "";

let renderIndex = 0;
for (let t = 1; t <= tables; t++) {

        const tableDiv = document.createElement("div");
        tableDiv.className = "seat-draw-table";

        const heading = document.createElement("div");
        heading.className = "seat-line";
        heading.innerHTML = `<strong>Table ${t}</strong>`;
        tableDiv.appendChild(heading);

        for (let s = 1; s <= seats; s++) {
           if (renderIndex >= shuffled.length) break;
const p = shuffled[renderIndex++];

            const line = document.createElement("div");
            line.className = "seat-line";
            line.innerHTML = `<span>Seat ${s}</span> <span>${p.name}</span>`;
            tableDiv.appendChild(line);
        }

        seatDrawResults.appendChild(tableDiv);
    }

    // --- NEW TAB VERSION ---
      openSeatDrawInNewTab(shuffled, tables, seats);
      populateMoveDropdowns(tables);
      }

// STEP 4 FUNCTION ‚Äî place this right after generateSeatDraw()
function populateMoveDropdowns(tables) {
    moveFromTable.innerHTML = "";
    moveToTable.innerHTML = "";

    for (let t = 1; t <= tables; t++) {
        moveFromTable.innerHTML += `<option value="${t}">Table ${t}</option>`;
        moveToTable.innerHTML += `<option value="${t}">Table ${t}</option>`;
    }
}

// STEP 5 ‚Äî Move one random player from one table to another
function moveRandomPlayer(fromTable, toTable) {
    const playersAtSource = seatAssignments.filter(a => a.table == fromTable);
    const playersAtDest = seatAssignments.filter(a => a.table == toTable);

    if (playersAtSource.length === 0) {
        alert("No players at that table.");
        return;
    }

    const randomIndex = Math.floor(Math.random() * playersAtSource.length);
    const chosen = playersAtSource[randomIndex];

    const seatsPerTable = parseInt(inputSeatsPerTable.value);
    const usedSeats = playersAtDest.map(a => a.seat);
    let emptySeat = null;

    for (let s = 1; s <= seatsPerTable; s++) {
        if (!usedSeats.includes(s)) {
            emptySeat = s;
            break;
        }
    }

    if (emptySeat === null) {
        alert("Destination table is full.");
        return;
    }

    chosen.table = toTable;
    chosen.seat = emptySeat;

    renderSeatDrawFromAssignments();
}




// STEP 5 ‚Äî Rebuild the seat draw UI from seatAssignments
function renderSeatDrawFromAssignments() {
    seatDrawResults.innerHTML = "";

    const grouped = {};

    seatAssignments.forEach(a => {
        if (!grouped[a.table]) grouped[a.table] = [];
        grouped[a.table].push(a);
    });

    for (const table in grouped) {
        const tableDiv = document.createElement("div");
        tableDiv.className = "seat-draw-table";

        const heading = document.createElement("div");
        heading.className = "seat-line";
        heading.innerHTML = `<strong>Table ${table}</strong>`;
        tableDiv.appendChild(heading);

        grouped[table]
            .sort((a, b) => a.seat - b.seat)
            .forEach(a => {
                const line = document.createElement("div");
                line.className = "seat-line";
                line.innerHTML = `<span>Seat ${a.seat}</span> <span>${a.player.name}</span>`;
                tableDiv.appendChild(line);
            });

        seatDrawResults.appendChild(tableDiv);
    }
}


function openSeatDrawInNewTab(shuffledPlayers, tables, seats) {
    const win = window.open("", "_blank");

    let html = `
        <html>
        <head>
            <title>Seat Draw</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    padding: 20px;
                    background: #111;
                    color: #fff;
                }
                .table-block {
                    margin-bottom: 30px;
                    padding: 15px;
                    border: 1px solid #444;
                    border-radius: 8px;
                    background: #1a1a1a;
                }
                .table-title {
                    font-size: 22px;
                    margin-bottom: 10px;
                    font-weight: bold;
                    color: #00d4ff;
                }
.seat-row {
    display: grid;
    grid-template-columns: 200px 1fr; /* doubled spacing (was 120px) */
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #333;
    font-size: 18px;
}

/* Alternating row colors */
.seat-row:nth-child(odd) {
    background: #1c1c1c;
}

.seat-row:nth-child(even) {
    background: #151515;
}

.seat-row:last-child {
    border-bottom: none;
}


            </style>
        </head>
        <body>
            <h1>Random Seat Draw</h1>
    `;

    let tabIndex = 0;

    for (let t = 1; t <= tables; t++) {
        html += `<div class="table-block">`;
        html += `<div class="table-title">Table ${t}</div>`;

        for (let s = 1; s <= seats; s++) {
            if (tabIndex >= shuffledPlayers.length) break;
            const p = shuffledPlayers[tabIndex++];
            html += `
                <div class="seat-row">
                    <span>Seat ${s}</span>
                    <span>${p.name}</span>
                </div>
            `;
        }

        html += `</div>`;
    }

    html += `
        </body>
        </html>
    `;

   setTimeout(() => {
    win.document.open();
    win.document.write(html);
    win.document.close();
}, 10);

}

function openUpdatedSeatDrawInNewTab() {
    const win = window.open("", "_blank");

    let html = `
        <html>
        <head>
            <title>Updated Seat Assignments</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    padding: 20px;
                    background: #111;
                    color: #fff;
                }
                .table-block {
                    margin-bottom: 30px;
                    padding: 15px;
                    border: 1px solid #444;
                    border-radius: 8px;
                    background: #1a1a1a;
                }
                .table-title {
                    font-size: 22px;
                    margin-bottom: 10px;
                    font-weight: bold;
                    color: #00d4ff;
                }
                .seat-row {
                    display: grid;
                    grid-template-columns: 200px 1fr;
                    align-items: center;
                    padding: 8px 0;
                    border-bottom: 1px solid #333;
                    font-size: 18px;
                }
                .seat-row:nth-child(odd) { background: #1c1c1c; }
                .seat-row:nth-child(even) { background: #151515; }
                .seat-row:last-child { border-bottom: none; }
            </style>
        </head>
        <body>
            <h1>Updated Seat Assignments</h1>
    `;

    const grouped = {};

    seatAssignments.forEach(a => {
        if (!grouped[a.table]) grouped[a.table] = [];
        grouped[a.table].push(a);
    });

    for (const table in grouped) {
        html += `<div class="table-block">`;
        html += `<div class="table-title">Table ${table}</div>`;

        grouped[table]
            .sort((a, b) => a.seat - b.seat)
            .forEach(a => {
                html += `
                    <div class="seat-row">
                        <span>Seat ${a.seat}</span>
                        <span>${a.player.name}</span>
                    </div>
                `;
            });

        html += `</div>`;
    }

    html += `</body></html>`;

    setTimeout(() => {
        win.document.open();
        win.document.write(html);
        win.document.close();
    }, 10);
}


// STEP 5 ‚Äî Button handler
btnMovePlayer.addEventListener("click", () => {
    const fromTable = parseInt(moveFromTable.value);
    const toTable = parseInt(moveToTable.value);

    if (fromTable === toTable) {
        alert("Choose two different tables.");
        return;
    }

    moveRandomPlayer(fromTable, toTable);
});

btnOpenUpdatedSeatDraw.addEventListener("click", () => {
    openUpdatedSeatDrawInNewTab();
});



/* ---------------------------------------------------------
   QR CODE
--------------------------------------------------------- */
function initQRCode() {
    const baseUrl = "https://bradgmerek-lang.github.io/tournament-clock/tournament-clock.html";

    const qrUrl = `${baseUrl}?tournament=${encodeURIComponent(tournamentId)}&mode=view`;

console.log("QR URL:", qrUrl);


    qrInstance = new QRious({
        element: qrCanvas,
        value: qrUrl,
        size: 180,
        background: 'transparent',
        foreground: '#00d4ff'
    });
}

/* ---------------------------------------------------------
   FIREBASE SYNC ‚Äî STATE SNAPSHOT
--------------------------------------------------------- */
function getChipState() {
    return {
        iconMode: chipIconMode,
        numChipColors,
        chips: chipConfigs.map(c => ({ color: c.color, value: c.value }))
    };
}

function getPayoutState() {
    return {
        entryFee: parseFloat(inputEntryFee.value) || 0,
        payouts: payouts.map(p => ({
            place: p.place,
            percent: p.percent,
            amount: p.amount
        }))
    };
}

function getPlayersState() {
    return {
        entered: parseInt(playersEnteredEl.textContent) || 0,
        remaining: parseInt(playersRemainingEl.textContent) || 0,
        startingStack: parseInt(inputStartingStack.value) || 0,
        players: players.map(p => ({
            id: p.id,
            name: p.name,
            active: p.active
        }))
    };
}


function getLevelsState() {
    return {
        levels,
        currentLevelIndex,
        timerSecondsLeft,
        timerTotalSeconds
    };
}

function getMetaState() {
    return {
        title: editableTitle.value || "Hold Em Tournament Timer"
    };
}

function getFullState() {
    return {
        meta: getMetaState(),
        levelsState: getLevelsState(),
        playersState: getPlayersState(),
        chipState: getChipState(),
        payoutState: getPayoutState()
    };
}

function pushStateToFirebase() {
    if (mode !== "control") return;
    const ref = db.ref("tournaments/" + tournamentId);
    ref.set(getFullState()).catch(console.error);
}

/* ---------------------------------------------------------
   FIREBASE SYNC ‚Äî APPLY STATE (VIEWER MODE)
--------------------------------------------------------- */
function applyStateFromFirebase(snapshotVal) {
    if (!snapshotVal) return;

    const { meta, levelsState, playersState, chipState, payoutState } = snapshotVal;

    // Title
    if (meta && meta.title) {
        editableTitle.value = meta.title;
    }

    // Levels & timer
   // Levels & timer (VIEW-ONLY SAFE)
if (levelsState) {
    levels = levelsState.levels || [];
  currentLevelIndex = levelsState.currentLevelIndex;
timerSecondsLeft = levelsState.timerSecondsLeft;
timerTotalSeconds = levelsState.timerTotalSeconds;

renderLevels();
updateTimerDisplay();

const lvl = levels[currentLevelIndex];
if (lvl) {
    currentLevelNumberEl.textContent = currentLevelIndex + 1;
    currentLevelMinutesEl.textContent = lvl.minutes;

    currentBlindsEl.textContent = lvl.type === "break"
        ? "BREAK"
        : `${lvl.sb} / ${lvl.bb}${lvl.ante ? " / " + lvl.ante : ""}`;

    const next = levels[currentLevelIndex + 1];
    nextBlindsEl.textContent = next
        ? (next.type === "break"
            ? "BREAK"
            : `${next.sb} / ${next.bb}${next.ante ? " / " + next.ante : ""}`)
        : "--";

    timerDisplay.classList.toggle("break-mode", lvl.type === "break");
}

}


    // Players
   if (playersState) {
    players = playersState.players || [];
    playersEnteredEl.textContent = playersState.entered ?? players.length;
    playersRemainingEl.textContent = playersState.remaining ?? players.filter(p => p.active).length;

    // NEW ‚Äî pull starting stack from Firebase
    startingStack = playersState.startingStack ?? startingStack;

    // NEW ‚Äî update viewer average stack
    updateAverageStack();

    // Viewer mode should NOT render the editor
    if (mode !== "view") {
        renderPlayersEditor();
    }
}


    // Chips
    if (chipState) {
        chipIconMode = chipState.iconMode || "emoji";
        chipIconModeSelect.value = chipIconMode;
        numChipColors = chipState.numChipColors || 3;
        numChipsSelect.value = String(numChipColors);

        if (Array.isArray(chipState.chips)) {
            chipConfigs = chipState.chips.map(c => ({ color: c.color, value: c.value }));
        }

        renderChipConfig();
        renderViewerChipBar();
    }

    // Payouts
    if (payoutState) {
        inputEntryFee.value = payoutState.entryFee ?? 0;
        payouts = payoutState.payouts || [];
        normalizePayoutPercents();
        renderPayouts();
        updatePrizePool();
    }

    // Details overlay content
    renderDetailsOverlay();
}

/* ---------------------------------------------------------
   DETAILS OVERLAY CONTENT
--------------------------------------------------------- */
function renderDetailsOverlay() {
let realLevelNumber = 0;
levels.forEach(lvl => {
    if (lvl.type === "level") {
        realLevelNumber++;
        lvl.displayNumber = realLevelNumber;
    } else {
        lvl.displayNumber = "Break";
    }
});

 // Chip values
detailsChipList.innerHTML = "";
chipConfigs.forEach(cfg => {
    const row = document.createElement("div");
    row.className = "details-chip-item";

    row.innerHTML = `
        <span class="details-chip-icon">
            ${chipIconMode === "emoji" 
                ? getEmojiChip(cfg.color) 
                : getSvgChip(cfg.color, cfg.value)
            }
        </span>
        <span class="details-chip-value">$${cfg.value}</span>
    `;

    detailsChipList.appendChild(row);
});


    // Blind schedule
    detailsBlindList.innerHTML = "";
    levels.forEach((lvl, i) => {
        const row = document.createElement("div");
       row.className = "details-blind-row";
        row.innerHTML = lvl.type === "break"
            ? `<span>Break</span><span>${lvl.minutes} min</span>`
           : `<span>Level ${lvl.displayNumber}</span><span>${lvl.sb} / ${lvl.bb}${lvl.ante ? " / " + lvl.ante : ""}</span>`;

        detailsBlindList.appendChild(row);
    });

    // Payouts
    detailsPayoutList.innerHTML = "";
    payouts.forEach(p => {
        const row = document.createElement("div");
        row.className = "details-payout-row";
        row.innerHTML = `
            <span>${p.place}${p.place===1?"st":p.place===2?"nd":p.place===3?"rd":"th"}</span>
            <span>${p.percent}% ‚Äî $${p.amount}</span>
        `;
        detailsPayoutList.appendChild(row);
    });
}
/* ---------------------------------------------------------
   LOAD / SAVE CONFIGS (LOCAL STORAGE)
--------------------------------------------------------- */
const STORAGE_KEY = "tournamentStructures";

function loadSavedConfigs() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;

    const list = JSON.parse(raw);
    savedConfigs.innerHTML = `<option value="">Load structure‚Ä¶</option>`;
    Object.keys(list).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        savedConfigs.appendChild(opt);
    });
}

function saveConfig() {
    const name = configName.value.trim();
    if (!name) {
        showToast("Enter a config name first");
        return;
    }

    const raw = localStorage.getItem(STORAGE_KEY);
    const list = raw ? JSON.parse(raw) : {};

    list[name] = {
        levels,
        chipConfigs,
        chipIconMode,
        numChipColors,
        payouts,
        entryFee: parseFloat(inputEntryFee.value) || 0
    };

    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    loadSavedConfigs();
    showToast("Saved");
}

function loadConfig() {
    const name = savedConfigs.value;
    if (!name) {
        showToast("Choose a saved config");
        return;
    }

    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;

    const list = JSON.parse(raw);
    const cfg = list[name];
    if (!cfg) return;

    levels = cfg.levels || [];
    chipConfigs = cfg.chipConfigs || [];
    chipIconMode = cfg.chipIconMode || "emoji";
    numChipColors = cfg.numChipColors || 3;
    payouts = cfg.payouts || [];
    inputEntryFee.value = cfg.entryFee || 0;

    chipIconModeSelect.value = chipIconMode;
    numChipsSelect.value = numChipColors;

    renderChipConfig();
    renderLevels();
    renderPayouts();
    updatePrizePool();
    pushStateToFirebase();
    showToast("Loaded");
}

function deleteConfig() {
    const name = savedConfigs.value;
    if (!name) {
        showToast("Choose a config to delete");
        return;
    }

    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;

    const list = JSON.parse(raw);
    delete list[name];
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    loadSavedConfigs();
    showToast("Deleted");
}

/* ---------------------------------------------------------
   DEFAULT STRUCTURE
--------------------------------------------------------- */
function loadDefaultStructure() {
    levels = [
        { type:"level", sb:25, bb:50, ante:0, minutes:20 },
        { type:"level", sb:50, bb:100, ante:0, minutes:20 },
        { type:"level", sb:75, bb:150, ante:0, minutes:20 },
        { type:"break", sb:0, bb:0, ante:0, minutes:10 },
        { type:"level", sb:100, bb:200, ante:0, minutes:20 }
    ];

    chipConfigs = [
        { color:"#ffffff", value:25 },
        { color:"#00ff00", value:100 },
        { color:"#ff0000", value:500 }
    ];

    payouts = [
        { place:1, percent:50, amount:0 },
        { place:2, percent:30, amount:0 },
        { place:3, percent:20, amount:0 }
    ];

    renderChipConfig();
    renderLevels();
    renderPayouts();
    updatePrizePool();
    pushStateToFirebase();
}

/* ---------------------------------------------------------
   POKERSOUP BLIND CURVE HELPERS
--------------------------------------------------------- */

// Round to nearest multiple of n
function roundTo(x, n) {
    return Math.round(x / n) * n;
}

// Determine multiplier based on level index (0-based)
function getPokerSoupMultiplier(levelIndex) {
    if (levelIndex < 4) return 1.3;   // smooth early
    if (levelIndex < 8) return 1.5;   // mid acceleration
    return 2.0;                       // late doubling
}

// Determine correct blind grid based on SB
function getBlindGrid(sb) {
    if (sb < 100) {
        return { sbStep: 25, bbStep: 50 };      // first 3 levels only
    } else if (sb < 1000) {
        return { sbStep: 100, bbStep: 200 };    // mid game
    } else if (sb < 5000) {
        return { sbStep: 500, bbStep: 1000 };   // late game
    } else {
        return { sbStep: 1000, bbStep: 2000 };  // ultra-late game (SB >= 5000)
    }
}



/* ---------------------------------------------------------
   SUGGEST BLINDS ‚Äî TARGET-BASED POKERSOUP CURVE
--------------------------------------------------------- */
function suggestBlinds() {
    const duration = parseFloat(inputDuration.value) || 4;
    const levelLength = parseInt(inputLevelLength.value) || 20;
    const breakFreq = parseInt(inputBreakFrequency.value) || 3;
    const breakMinutes = parseInt(inputBreakMinutes.value) || 10;

    const players = parseInt(inputPlayersEntered.value) || 10;
    const startingStack = 20000;

    const totalChips = players * startingStack;

    // Target final BB = ~7.5% of total chips, rounded to 100
    const targetFinalBB = roundTo(totalChips * 0.075, 100);

    // Number of blind levels (breaks not counted)
    const numLevels = Math.floor((duration * 60) / levelLength);

    // Smooth exponential growth factor
    const startBB = 50;
    const growth = Math.pow(targetFinalBB / startBB, 1 / (numLevels - 1));

    const structure = [];
    let sb = 25;
    let bb = 50;
    let blindLevelCount = 0;
const latePhaseStart = Math.floor(numLevels * 0.66);


    for (let i = 0; i < numLevels; i++) {

     // Insert break every X blind levels
if (blindLevelCount > 0 && blindLevelCount % breakFreq === 0) {
    structure.push({
        type: "break",
        sb: 0,
        bb: 0,
        ante: 0,
        minutes: breakMinutes
    });
}

// Add level
structure.push({
    type: "level",
    sb,
    bb,
    ante: 0,
    minutes: levelLength
});

// Only increment on real levels
blindLevelCount++;


        // Compute next BB using exponential curve
       let nextBB = Math.round(startBB * Math.pow(growth, blindLevelCount));


        // Apply PokerSoup flavor multipliers
        if (blindLevelCount < 4) nextBB *= 0.9;                     // early slow
      else if (blindLevelCount > latePhaseStart) nextBB *= 1.1;
// late fast

// Determine correct grid based on current SB
const grid = getBlindGrid(sb);

// Round BB to correct grid
nextBB = roundTo(nextBB, grid.bbStep);

// Enforce no duplicates
if (nextBB <= bb) nextBB = bb + grid.bbStep;

// Finalize blinds
bb = nextBB;
sb = bb / 2;
    }

    levels = structure;
    renderLevels();
    pushStateToFirebase();
    showToast("PokerSoup-style blinds suggested");
}



function autoSuggestNextLevel() {
    let last = null;
    for (let i = levels.length - 1; i >= 0; i--) {
        if (levels[i].type === "level") {
            last = levels[i];
            break;
        }
    }

    if (!last) {
        return { sb: 25, bb: 50, ante: 0, minutes: 20 };
    }

    const levelIndex = levels.filter(l => l.type === "level").length;
    const mult = getPokerSoupMultiplier(levelIndex);

// Determine correct grid based on last SB
const grid = getBlindGrid(last.sb);

// Compute next BB float
let nextBBFloat = Math.round(last.bb * mult);

// Round to correct grid
let nextBB = roundTo(nextBBFloat, grid.bbStep);

// Enforce no duplicates
if (nextBB <= last.bb) nextBB = last.bb + grid.bbStep;

const nextSB = nextBB / 2;


    return {
        sb: nextSB,
        bb: nextBB,
        ante: 0,
        minutes: last.minutes
    };
}



/* ---------------------------------------------------------
   ADD LEVEL ‚Äî WITH AUTO-SUGGESTED BLINDS
--------------------------------------------------------- */
function addLevel() {
    const suggested = autoSuggestNextLevel();

    levels.push({
        type: "level",
        sb: suggested.sb,
        bb: suggested.bb,
        ante: 0,
        minutes: suggested.minutes
    });

    renderLevels();
    pushStateToFirebase();
    showToast("Level added (auto-suggested)");
}


/* ---------------------------------------------------------
   EVENT LISTENERS
--------------------------------------------------------- */
btnAddLevel.addEventListener("click", () => {
    addLevel();
    showToast("Level added");
});

btnInsertBreak.addEventListener("click", () => {
    insertBreak();
    showToast("Break added");
});

btnStartPause.addEventListener("click", () => {
    if (timerInterval) pauseTimer();
    else startTimer();
    pushStateToFirebase();
});

btnReset.addEventListener("click", () => {
    resetTimer();
    showToast("Timer reset");
});

btnPrevLevel.addEventListener("click", () => {
    goToPrevLevel();
});

btnNextLevel.addEventListener("click", () => {
    goToNextLevel();
});

btnSuggestBlinds.addEventListener("click", () => {
    suggestBlinds();
    showToast("Blinds suggested");
});

btnToggleQR.addEventListener("click", () => {
    const isHidden = getComputedStyle(qrPanel).display === "none";
    qrPanel.style.display = isHidden ? "block" : "none";

    if (isHidden) {
        requestAnimationFrame(() => {
            initQRCode(); // or qr.update({ value: buildViewerUrl() });
        });
    }
});


btnSaveConfig.addEventListener("click", saveConfig);
btnLoadConfig.addEventListener("click", loadConfig);
btnDeleteConfig.addEventListener("click", deleteConfig);
btnLoadDefault.addEventListener("click", loadDefaultStructure);

inputPlayersEntered.addEventListener("input", createPlayersFromEntered);
inputEntryFee.addEventListener("input", updatePrizePool);
inputNumPayouts.addEventListener("input", regeneratePayoutsFromModel);

btnRegenPayouts.addEventListener("click", regeneratePayoutsFromModel);
payoutMode.addEventListener("change", () => {
    renderPayouts();
    updatePrizePool();
    pushStateToFirebase();
});


btnSeatDraw.addEventListener("click", () => {
    const tables = parseInt(inputTables.value) || 1;
    const seats = parseInt(inputSeatsPerTable.value) || 1;

    // Generate the on-page version
    generateSeatDraw();

    // Generate the new-tab version (popup-safe)
    const activePlayers = players.filter(p => p.active);
    const shuffled = [...activePlayers].sort(() => Math.random() - 0.5);
    openSeatDrawInNewTab(shuffled, tables, seats);

    showToast("Seat draw generated");
});


btnSyncPlayersCount.addEventListener("click", () => {
    createPlayersFromEntered();
    showToast("Players synced");
});

chipIconModeSelect.addEventListener("change", () => {
    chipIconMode = chipIconModeSelect.value;
    renderChipConfig();
    renderViewerChipBar();
    pushStateToFirebase();
});

numChipsSelect.addEventListener("change", () => {
    numChipColors = parseInt(numChipsSelect.value);
    chipConfigs.length = numChipColors;
    renderChipConfig();
    renderViewerChipBar();
    pushStateToFirebase();
});

soundToggle.dataset.enabled = "true";
soundToggle.addEventListener("click", () => {
    const enabled = soundToggle.dataset.enabled === "true";
    soundToggle.dataset.enabled = enabled ? "false" : "true";
    soundToggle.textContent = enabled ? "üîá Sound: OFF" : "üîä Sound: ON";
});

/* ---------------------------------------------------------
   VIEWER MODE SETUP
--------------------------------------------------------- */
function setupViewerMode() {
    appContainer.classList.add("viewer-mode");
    rightPanel.style.display = "none";
    btnShowDetails.style.display = "inline-flex";
    renderViewerChipBar();
}

/* ---------------------------------------------------------
   INITIALIZATION
--------------------------------------------------------- */
window.addEventListener("load", () => {
    loadSavedConfigs();
    loadDefaultStructure();
    createPlayersFromEntered();
    renderViewerChipBar();
    initQRCode();

    if (mode === "view") {
        setupViewerMode();

        const ref = db.ref("tournaments/" + tournamentId);
        ref.on("value", snap => {
            applyStateFromFirebase(snap.val());
        });
   } else {
    pushStateToFirebase();

}

});
/* ---------------------------------------------------------
   RENDER DETAILS OVERLAY (ALREADY CALLED IN SYNC)
--------------------------------------------------------- */
// (Function already defined in Part 6 ‚Äî included here for completeness)

/* ---------------------------------------------------------
   END OF SCRIPT
--------------------------------------------------------- */
</script>

</body>
</html>
